<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monarch — Service Menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* --- CORE VARIABLES --- */
    :root {
      --bg-body: #0a0a0a;
      --bg-card: #141414;
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --accent: #ef4444; /* Neon Red */
      --border: rgba(255, 255, 255, 0.1);
      --font-body: 'Inter', sans-serif;
    }

    /* --- RESET --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg-body);
      color: var(--text-main);
      font-family: var(--font-body);
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* --- UTILITIES --- */
    .container { max-width: 900px; margin: 0 auto; padding: 0 24px; }
    
    .btn {
      display: inline-flex; background: var(--accent); color: white;
      padding: 12px 24px; font-weight: 800; text-transform: uppercase; font-size: 11px;
      letter-spacing: 0.05em; text-decoration: none; border-radius: 4px;
      transition: 0.2s; border: none; cursor: pointer;
    }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
    
    h1 { font-size: 32px; font-weight: 900; letter-spacing: -0.04em; text-transform: uppercase; margin-bottom: 40px; }
    .tagline { color: var(--accent); font-weight: 800; font-size: 11px; letter-spacing: 0.2em; text-transform: uppercase; display: block; margin-bottom: 12px; }

    /* --- NAVIGATION --- */
    nav {
      position: sticky; top: 0; width: 100%; padding: 20px 24px; z-index: 50;
      background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .brand { font-weight: 900; font-size: 20px; letter-spacing: -0.05em; font-style: italic; color: white; text-decoration: none; }
    
    .nav-links { display: flex; gap: 24px; }
    .nav-links a { color: var(--text-muted); text-decoration: none; font-size: 12px; font-weight: 700; text-transform: uppercase; transition: 0.2s; }
    .nav-links a:hover, .nav-links a.active { color: white; }
    @media(max-width: 768px) { .nav-links { display: none; } }

    /* --- MENU GRID --- */
    .menu-section { margin-bottom: 60px; }
    .menu-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    
    .menu-item {
      display: flex; justify-content: space-between; align-items: center;
      background: var(--bg-card); border: 1px solid var(--border);
      padding: 24px; transition: 0.2s; cursor: pointer;
    }
    .menu-item:hover { border-color: var(--accent); transform: translateX(4px); }

    .item-info h3 { font-size: 16px; font-weight: 800; margin-bottom: 4px; }
    .item-info p { font-size: 13px; color: var(--text-muted); max-width: 400px; }
    
    .item-price { font-size: 18px; font-weight: 800; color: var(--accent); white-space: nowrap; }
    .book-mini {
      background: transparent; border: 1px solid var(--border); color: white;
      padding: 8px 16px; font-size: 10px; font-weight: 700; text-transform: uppercase;
      margin-left: 20px; transition: 0.2s; cursor: pointer;
    }
    .menu-item:hover .book-mini { background: white; color: black; border-color: white; }

    /* --- FOOTER --- */
    footer { border-top: 1px solid var(--border); padding: 40px 0; text-align: center; color: var(--text-muted); font-size: 12px; }

  </style>
</head>
<body>

  <nav>
    <a href="index.html" class="brand" id="nsBrandTop">MONARCH</a>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="services.html" class="active">Services</a>
      <a href="team.html">The Squad</a>
      <a href="contact.html">Contact</a>
    </div>
    <button type="button" class="btn" onclick="window.openBooking?.()">Book Now</button>
  </nav>

  <main class="container" style="padding-top: 60px;">
    
    <div class="text-center" style="margin-bottom: 40px;">
      <span class="tagline" id="nsServicesHeroLabel">The Menu</span>
      <h1 id="nsServicesHeroTitle">Precision Grooming</h1>
    </div>

    <div id="nsCategoryList"></div>

  </main>

  <footer>
    <div class="container">
      <div id="nsBrandFooter" style="font-weight:900; font-size:20px; font-style:italic; margin-bottom:10px;">MONARCH</div>
      <p id="nsServicesFooterCopyright">© 2026 Monarch Hair Club. Powered by Net Studio.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    lucide.createIcons();

    // ---------- SLUG LOGIC ----------
    function nsGetSlugFromHost() {
      const qp = new URLSearchParams(location.search).get("b");
      if (qp) return String(qp).trim().toLowerCase();

      const host = (location.hostname || "").toLowerCase();
      if (!host || host === "localhost" || host.startsWith("127.")) return null;

      const ROOT = "netstudiodevelopment.com";
      if (host === ROOT || host === "www." + ROOT) return null;

      if (host.endsWith("." + ROOT)) {
        const slug = host.slice(0, -(ROOT.length + 1)).split(".")[0];
        return slug || null;
      }
      return null;
    }

    function nsShouldUseQuerySlug() {
      const host = (location.hostname || "").toLowerCase();
      return host.endsWith(".pages.dev") || host.endsWith(".workers.dev") || host === "localhost" || host.startsWith("127.");
    }

    function nsLinkWithSlug(targetPath) {
      const slug = nsGetSlugFromHost();
      if (!slug) return targetPath;
      if (!nsShouldUseQuerySlug()) return targetPath;

      const u = new URL(targetPath, location.href);
      u.searchParams.set("b", slug);
      return u.pathname + "?" + u.searchParams.toString() + u.hash;
    }

    function nsWireHeaderNav() {
      document.querySelectorAll("a.nav-link[data-page]").forEach(a => {
        const page = a.getAttribute("data-page") || a.getAttribute("href") || "index.html";
        a.setAttribute("href", nsLinkWithSlug(page));

        const current = (location.pathname.split("/").pop() || "index.html").toLowerCase();
        a.classList.toggle("active", page.toLowerCase() === current);
      });
    }
    document.addEventListener("DOMContentLoaded", nsWireHeaderNav);

    // ---------- SUPABASE ----------
    window.NS = {
      ...(window.NS || {}),
      SUPABASE_URL: "https://jdvdgvolfmvlgyfklbwe.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek",
      BUSINESS_SLUG: nsGetSlugFromHost()
    };

    const sb = window.supabaseClient || window.supabase.createClient(window.NS.SUPABASE_URL, window.NS.SUPABASE_ANON_KEY);
    window.supabaseClient = sb;

    async function nsLoadBusiness() {
      if (!window.NS.BUSINESS_SLUG) return null;

      const { data, error } = await sb
        .from("business")
        .select("id,name,logo_url")
        .eq("slug", window.NS.BUSINESS_SLUG)
        .maybeSingle();

      if (error || !data) return null;
      window.BUSINESS_ID = data.id;

      try { localStorage.setItem("ns_business_id", data.id); } catch(e) {}

      return data;
    }

    // --- PATCH 2: Content Loader ---
    async function nsLoadSiteContent() {
      if (!window.BUSINESS_ID) return null;

      // Monarch template key is fixed on this page
      const { data, error } = await sb
        .from("business_sites")
        .select("content_json")
        .eq("business_id", window.BUSINESS_ID)
        .eq("template_key", "monarch_v1")
        .maybeSingle();

      if (error || !data) return null;
      return data.content_json || null;
    }

    // --- PATCH 3: Content Applicator ---
    function nsApplyServicesContent(content_json) {
      const s = content_json?.services || null;
      const foot = content_json?.footer || null; // Some templates put footer in root, some in page. Handling safe fallback.

      const heroLabelEl = document.getElementById("nsServicesHeroLabel");
      const heroTitleEl = document.getElementById("nsServicesHeroTitle");
      const ftCopyrightEl = document.getElementById("nsServicesFooterCopyright");
      const ftBrandEl = document.getElementById("nsBrandFooter"); // Handled in init, but can override here if needed

      // Store UI strings for menu renderer
      window.NS_SERVICES_UI = {
        empty_state: s?.ui?.empty_state ?? "",
        book_button_label: s?.ui?.book_button_label ?? "Book"
      };

      if (heroLabelEl) heroLabelEl.textContent = s?.hero?.label ?? "";
      if (heroTitleEl) heroTitleEl.textContent = s?.hero?.title ?? "";
      
      // Footer might be in s.footer or root footer. We check s.footer first based on Canvas/Haven pattern
      if (ftCopyrightEl && s?.footer?.copyright) ftCopyrightEl.textContent = s.footer.copyright;
      if (ftBrandEl && s?.footer?.title) ftBrandEl.textContent = s.footer.title;
    }

    async function nsLoadMenuItems() {
      if (!window.BUSINESS_ID) return [];
      const { data, error } = await sb
        .from("menu_items")
        .select("*")
        .eq("business_id", window.BUSINESS_ID)
        .eq("is_active", true)
        .order("section", { ascending: true })
        .order("name", { ascending: true });

      if (error) return [];
      return data || [];
    }

    function nsMoneyFromRow(row) {
      if (typeof row.price_cents === "number") {
        const dollars = row.price_cents / 100;
        return Number.isFinite(dollars) ? `$${dollars.toFixed(2)}` : "";
      }
      if (row.price != null && row.price !== "") {
        const n = Number(row.price);
        return Number.isFinite(n) ? `$${n.toFixed(2)}` : String(row.price);
      }
      return "";
    }

    // --- Safety Escaper ---
    function nsEscapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // --- PATCH 4: Dynamic Renderer ---
    function nsRenderMenu(items) {
      const mount = document.getElementById("nsCategoryList");
      if (!mount) return;

      if (!items.length) {
        // Use dynamic empty state
        mount.innerHTML = `<div style="opacity:.7; padding:20px 0;">${nsEscapeHtml(window.NS_SERVICES_UI?.empty_state || "No services found.")}</div>`;
        return;
      }

      const groups = {};
      items.forEach(i => {
        const cat = (i.section || "Services").trim();
        (groups[cat] ||= []).push(i);
      });

      mount.innerHTML = "";
      
      // Use dynamic button label
      const btnLabel = nsEscapeHtml(window.NS_SERVICES_UI?.book_button_label || "Book");

      Object.entries(groups).forEach(([cat, rows]) => {
        const section = document.createElement("div");
        section.className = "menu-section";

        section.innerHTML = `
          <h3 style="color:var(--text-muted); font-size:12px; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px;">
            ${nsEscapeHtml(cat)}
          </h3>
          <div class="menu-grid">
            ${rows.map(r => `
              <div class="menu-item" onclick="window.openBooking?.('${r.id}')">
                <div class="item-info">
                  <h3>${nsEscapeHtml(r.name)}</h3>
                  <p>${nsEscapeHtml(r.description)}</p>
                </div>
                <div style="display:flex; align-items:center;">
                  <span class="item-price">${nsEscapeHtml(nsMoneyFromRow(r))}</span>
                  <button type="button" class="book-mini"
                    onclick="event.stopPropagation(); window.openBooking?.('${r.id}')">
                    ${btnLabel}
                  </button>
                </div>
              </div>
            `).join("")}
          </div>
        `;
        mount.appendChild(section);
      });
    }

    function nsLoadBookingEngineScript() {
      const s = document.createElement("script");
      s.src = "./netstudio_booking.js";
      s.defer = true;
      document.body.appendChild(s);
    }

    // --- PATCH 5: Init Sequence ---
    (async () => {
      const biz = await nsLoadBusiness();
      if (!biz) return;

      // 1. Basic Branding (Logo/Name fallback)
      (function nsApplyBusinessName(biz){
        const name = (biz?.name || "").trim();
        if (!name) return;

        const top = document.getElementById("nsBrandTop");
        const foot = document.getElementById("nsBrandFooter");

        if (top) top.textContent = name.toUpperCase();
        if (foot) foot.textContent = name.toUpperCase();
      })(biz);

      // 2. Load & Apply JSON Content (Overrides branding if JSON exists)
      const content = await nsLoadSiteContent();
      nsApplyServicesContent(content);

      // 3. Load Menu Items & Render
      const items = await nsLoadMenuItems();
      nsRenderMenu(items);

      nsLoadBookingEngineScript();
    })();
  </script>
</body>
</html>
