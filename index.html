<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Barbershop — Powered by Net Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    window.nsOpenBooking = window.nsOpenBooking || function(payload = {}) {
      if (window.NetStudio && typeof window.NetStudio.open === "function") return window.NetStudio.open(payload);
      console.warn("Booking engine loading...");
    };
  </script>

  <style>
    /* --- CORE VARIABLES --- */
    :root {
      --bg-body: #0a0a0a;
      --bg-card: #141414;
      --text-main: #ffffff;
      --text-muted: #a1a1aa;
      --accent: #ef4444; 
      --border: rgba(255, 255, 255, 0.1);
      --font-body: 'Inter', sans-serif;
    }

    /* --- RESET --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg-body);
      color: var(--text-main);
      font-family: var(--font-body);
      line-height: 1.5;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    h1 { font-size: clamp(40px, 8vw, 64px); font-weight: 900; line-height: 0.95; letter-spacing: -0.04em; text-transform: uppercase; margin-bottom: 24px; }
    h2 { font-size: 32px; font-weight: 800; text-transform: uppercase; letter-spacing: -0.02em; margin-bottom: 16px; }
    .tagline { color: var(--accent); font-weight: 800; font-size: 11px; letter-spacing: 0.2em; text-transform: uppercase; display: block; margin-bottom: 12px; }

    .container { max-width: 1100px; margin: 0 auto; padding: 0 24px; }
    .section-pad { padding: 80px 0; }
    .btn {
      display: inline-flex; background: var(--accent); color: white;
      padding: 14px 28px; font-weight: 700; text-transform: uppercase; font-size: 12px;
      letter-spacing: 0.05em; text-decoration: none; border-radius: 4px;
      transition: 0.2s; border: none; cursor: pointer;
    }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
    .btn.outline { background: transparent; border: 1px solid var(--border); }
    .btn.outline:hover { border-color: white; }

    nav {
      position: absolute; top: 0; width: 100%; padding: 30px 24px; z-index: 50;
      display: flex; justify-content: space-between; align-items: center;
    }
    .brand { font-weight: 900; font-size: 20px; letter-spacing: -0.05em; font-style: italic; }
    
    .hero {
      min-height: 85vh; display: flex; align-items: center;
      background-size: cover; background-position: center;
      border-bottom: 1px solid var(--border);
    }
    .hero-content { max-width: 600px; }

    .svc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 40px; }
    .svc-card { background: var(--bg-card); border: 1px solid var(--border); padding: 30px; transition: 0.2s; }
    .svc-card:hover { border-color: var(--accent); }
    .svc-icon { color: var(--accent); margin-bottom: 16px; width: 28px; height: 28px; }

    .squad-section { background: #000; overflow: hidden; }
    .squad-scroll { display: flex; gap: 30px; overflow-x: auto; padding-bottom: 20px; scrollbar-width: none; }
    .squad-card { min-width: 180px; text-align: center; cursor: pointer; }
    .squad-img { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 3px solid var(--bg-card); margin: 0 auto 16px; transition: 0.3s; }
    .squad-card:hover .squad-img { border-color: var(--accent); transform: scale(1.05); }
    .handle { color: var(--accent); font-size: 11px; font-weight: 700; text-transform: uppercase; margin-top: 4px; }

    .why-row { display: flex; gap: 20px; margin-bottom: 30px; }
    .why-num { font-size: 32px; font-weight: 900; color: #333; line-height: 1; }
    
    footer { border-top: 1px solid var(--border); padding: 40px 0; text-align: center; color: var(--text-muted); font-size: 12px; }
    
    #site-error { display: none; text-align: center; padding: 100px 20px; color: #666; font-size: 14px; }
  </style>
</head>
<body id="home">

  <div id="site-error">
    <h2>404</h2>
    <p>We couldn't find a barbershop at this address.</p>
  </div>

  <div id="main-content">
    <nav>
      <div class="brand" id="nav_logo">MONARCH</div>
      <a href="#book" class="btn" style="padding: 10px 20px; font-size: 11px;" onclick="window.nsOpenBooking(); return false;">Book Now</a>
    </nav>

    <header class="hero" id="ns_hero">
      <div class="container hero-content">
        <span class="tagline" id="hero_kicker"></span>
        <h1 id="hero_headline"></h1>
        <p id="hero_subheadline" style="color:var(--text-muted); font-size:18px; margin-bottom:32px; max-width:400px;"></p>
        <div style="display:flex; gap:16px;">
          <a href="#book" class="btn" onclick="window.nsOpenBooking(); return false;">Book Now</a>
          <a href="services.html" class="btn outline">View Menu</a>
        </div>
      </div>
    </header>

    <section class="container section-pad">
      <span class="tagline" id="services_kicker"></span>
      <h2 id="services_title"></h2>
      <div class="svc-grid">
        <div class="svc-card">
          <i data-lucide="scissors" class="svc-icon"></i>
          <h3 style="font-size:16px; font-weight:700; margin-bottom:8px;">Haircuts</h3>
          <p style="font-size:13px; color:var(--text-muted);">Clean fades, tapers, and classic cuts.</p>
        </div>
        <div class="svc-card">
          <i data-lucide="user" class="svc-icon"></i>
          <h3 style="font-size:16px; font-weight:700; margin-bottom:8px;">Beard Trim</h3>
          <p style="font-size:13px; color:var(--text-muted);">Sharp lineups and detailed grooming.</p>
        </div>
        <div class="svc-card">
          <i data-lucide="zap" class="svc-icon"></i>
          <h3 style="font-size:16px; font-weight:700; margin-bottom:8px;">Hot Towel</h3>
          <p style="font-size:13px; color:var(--text-muted);">Traditional shave experience.</p>
        </div>
        <div class="svc-card">
          <i data-lucide="smile" class="svc-icon"></i>
          <h3 style="font-size:16px; font-weight:700; margin-bottom:8px;">Kids' Cuts</h3>
          <p style="font-size:13px; color:var(--text-muted);">Comfortable cuts for young clients.</p>
        </div>
      </div>
    </section>

    <section class="section-pad squad-section">
      <div class="container">
        <span class="tagline" id="squad_kicker"></span>
        <h2 id="squad_title" style="margin-bottom:40px;"></h2>
        <div class="squad-scroll" id="team_scroll">
           </div>
      </div>
    </section>

    <section class="container section-pad">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:60px;">
        <div>
          <span class="tagline" id="why_kicker"></span>
          <h2 id="why_title" style="margin-bottom:40px;"></h2>
          <div id="why_items">
             </div>
        </div>
        <div>
          <span class="tagline">Visit Us</span>
          <h2 id="biz_city"></h2>
          <p style="color:var(--text-muted); margin-bottom:20px;">
            <span id="biz_address"></span><br>
            <span id="biz_phone"></span>
          </p>
          <div style="width:100%; height:300px; background:#222; border:1px solid var(--border); border-radius:12px; overflow:hidden; filter:grayscale(100%);">
             <iframe id="map_frame" width="100%" height="100%" frameborder="0" style="border:0"></iframe>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <div class="container">
        <div id="footer_logo" style="font-weight:900; font-size:20px; font-style:italic; margin-bottom:10px;"></div>
        <p id="footer_copy"></p>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const pick = (...vals) => vals.find(v => v !== undefined && v !== null && String(v).trim() !== "") || "";
      const BLANK_IMG = "data:image/gif;base64,R0lGODlhAQABAAAAACw="; // ✅ Fix 3: Image fallback

      function nsDetectSlugProdOnly() {
        const ROOT = "netstudiodevelopment.com";
        const host = (location.hostname || "").toLowerCase();
        if (!host || host === ROOT || host === "www." + ROOT) return null;
        if (!host.endsWith("." + ROOT)) return null;
        const prefix = host.slice(0, -(ROOT.length + 1));
        if (!prefix || prefix.includes(".")) return null;
        return prefix.trim();
      }

      const NS = {
        SB_URL: "https://jdvdgvolfmvlgyfklbwe.supabase.co",
        SB_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek",
        SLUG: nsDetectSlugProdOnly(),
        FALLBACK_TEMPLATE: "monarch_v1"
      };

      function show404(){
        const e = document.getElementById("site-error");
        const m = document.getElementById("main-content");
        if (e) e.style.display = "block";
        if (m) m.style.display = "none";
      }

      const sb = supabase.createClient(NS.SB_URL, NS.SB_KEY);

      function nsLoadBookingEngine() {
        return new Promise((resolve) => {
          if (window.NetStudio && typeof window.NetStudio.open === "function") return resolve(true);
          const s = document.createElement("script");
          s.src = "/netstudio_booking.js";
          s.async = true;
          s.onload = () => resolve(true);
          s.onerror = () => resolve(false);
          document.body.appendChild(s);
        });
      }

      function apply(data, biz) {
        const home = data.home || {};
        const hero = home.hero || {};
        const services = home.services || {}; 
        const features = home.features || {}; 
        const extra = home.section_extra || {};

        const bName = (biz.name || "MONARCH").toUpperCase();
        if ($("nav_logo")) $("nav_logo").textContent = bName;
        if ($("footer_logo")) $("footer_logo").textContent = bName;
        
        // ✅ Fix 2: Footer copy undefined check
        if ($("footer_copy")) {
          $("footer_copy").textContent = `© ${new Date().getFullYear()} ${pick(biz.name, bName)}. Powered by Net Studio.`;
        }

        const hBg = pick(hero.bg, hero.bg_image, biz.hero_bg_url, "https://images.unsplash.com/photo-1621605815971-fbc98d665033?auto=format&fit=crop&q=80&w=2000");
        if ($("ns_hero")) $("ns_hero").style.backgroundImage = `linear-gradient(to right, rgba(0,0,0,0.8), rgba(0,0,0,0.4)), url('${hBg}')`;
        
        if ($("hero_kicker")) $("hero_kicker").textContent = pick(hero.kicker, "Norfolk's Premier Studio");
        if ($("hero_headline")) $("hero_headline").innerHTML = pick(hero.headline, "Premium Cuts.<br>Fair Prices.");
        if ($("hero_subheadline")) $("hero_subheadline").textContent = pick(hero.subheadline, "Top-tier fades and lineups.");

        if ($("services_kicker")) $("services_kicker").textContent = pick(services.kicker, "What We Do");
        if ($("services_title")) $("services_title").textContent = pick(services.title, "Precision Grooming");
        
        if ($("squad_kicker")) $("squad_kicker").textContent = pick(extra.kicker, "");
        if ($("squad_title")) $("squad_title").textContent = pick(extra.headline, "");

        if ($("why_kicker")) $("why_kicker").textContent = pick(features.kicker, "Why Monarch");
        if ($("why_title")) $("why_title").textContent = pick(features.title, "The Top Choice");

        const whyItems = Array.isArray(features.items) ? features.items : null;
        if ($("why_items")) {
          if (!whyItems || whyItems.length === 0) {
            $("why_items").innerHTML = `<div style="color:var(--text-muted); font-size:13px;">Loading...</div>`;
          } else {
            $("why_items").innerHTML = whyItems.map(i => `
              <div class="why-row">
                <div class="why-num">${pick(i.num, "")}</div>
                <div>
                  <h4 style="font-weight:700; margin-bottom:4px;">${pick(i.label, "")}</h4>
                  <p style="font-size:13px; color:var(--text-muted);">${pick(i.text, "")}</p>
                </div>
              </div>
            `).join("");
          }
        }

        const address = [biz.street_address, biz.city, biz.state].filter(Boolean).join(", ");
        if ($("biz_city")) $("biz_city").textContent = biz.city || "Norfolk, VA";
        if ($("biz_address")) $("biz_address").textContent = address;
        if ($("biz_phone")) $("biz_phone").textContent = biz.phone || "";
        
        // ✅ Fix 1: Map URL construction
        if ($("map_frame")) {
          $("map_frame").src = `https://maps.google.com/maps?q=${encodeURIComponent(address)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
        }

        if (window.lucide) lucide.createIcons();
      }

      async function init() {
        if (!NS.SLUG) { show404(); return; }
        
        const { data: biz } = await sb.from("business").select("*").eq("slug", NS.SLUG).maybeSingle();
        if (!biz) { show404(); return; }

        window.NS_BUSINESS_ID = biz.id;
        document.documentElement.setAttribute("data-ns-business-id", String(biz.id));

        const { data: pointer } = await sb.from("business_sites_one").select("active_template_key").eq("business_id", biz.id).maybeSingle();
        const activeKey = pointer?.active_template_key || NS.FALLBACK_TEMPLATE;

        nsLoadBookingEngine();

        const [siteRes, teamRes] = await Promise.all([
          sb.from("business_sites").select("content_json").eq("business_id", biz.id).eq("template_key", activeKey).maybeSingle(),
          sb.from("team_members").select("*").eq("business_id", biz.id).eq("is_active", true).not("auth_user_id", "is", null)
        ]);

        const team = Array.isArray(teamRes.data) ? teamRes.data : [];
        if ($("team_scroll")) {
          if (team.length === 0) {
            $("team_scroll").innerHTML = `<div style="color:var(--text-muted); font-size:13px; width:100%; text-align:center;">Loading...</div>`;
          } else {
            // ✅ Fix 3: Image fallback logic
            $("team_scroll").innerHTML = team.map(m => {
              const img = pick(m.profile_image_url, BLANK_IMG);
              const role = pick(m.role, "");
              return `
              <div class="squad-card" onclick="window.location.href='team.html?b=${NS.SLUG}'">
                <img src="${img}" class="squad-img" alt="${pick(m.name, "")}">
                <div style="font-weight:700; font-size:14px;">${pick(m.name, "")}</div>
                ${role ? `<div class="handle">@${role.toUpperCase()}</div>` : ``}
              </div>
            `;
            }).join("");
          }
        }

        if (!siteRes.data) {
          console.warn(`[NetStudio] Missing business_sites row: template=${activeKey}, business_id=${biz.id}`);
        }

        apply(siteRes.data?.content_json || {}, biz);
      }
      
      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
